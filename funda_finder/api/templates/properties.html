{% extends "base.html" %}

{% block title %}Properties - Funda Property Finder{% endblock %}

{% block content %}
<div class="card">
    <h1>Property Listings</h1>

    <!-- Scrape Controls -->
    <div class="scrape-controls" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h3 style="margin-top: 0;">Scrape New Properties</h3>
        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
            <div class="form-group" style="margin: 0;">
                <label for="scrape-city">City</label>
                <select id="scrape-city" style="width: 150px;">
                    <option value="amsterdam">Amsterdam</option>
                    <option value="rotterdam">Rotterdam</option>
                    <option value="den-haag">Den Haag</option>
                    <option value="utrecht">Utrecht</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label for="scrape-type">Type</label>
                <select id="scrape-type" style="width: 100px;">
                    <option value="buy">Buy</option>
                    <option value="rent">Rent</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label for="scrape-pages">Pages (15 each)</label>
                <input type="number" id="scrape-pages" value="10" min="1" max="100" style="width: 80px;">
            </div>
            <button onclick="triggerScrape()" class="btn" id="scrape-btn">
                üîÑ Scrape Properties
            </button>
        </div>
        <div id="scrape-status" style="margin-top: 10px; font-size: 14px;"></div>
    </div>

    <form class="filter-form" hx-get="/api/properties" hx-target="#properties-list" hx-trigger="submit, change">
        <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" name="city" placeholder="e.g., Amsterdam">
        </div>

        <div class="form-group">
            <label for="listing_type">Type</label>
            <select id="listing_type" name="listing_type">
                <option value="">All</option>
                <option value="buy">Buy</option>
                <option value="rent">Rent</option>
            </select>
        </div>

        <div class="form-group">
            <label for="min_price">Min Price (‚Ç¨)</label>
            <input type="number" id="min_price" name="min_price" placeholder="0">
        </div>

        <div class="form-group">
            <label for="max_price">Max Price (‚Ç¨)</label>
            <input type="number" id="max_price" name="max_price" placeholder="1000000">
        </div>

        <div class="form-group">
            <label for="min_rooms">Min Rooms</label>
            <input type="number" id="min_rooms" name="min_rooms" placeholder="1">
        </div>

        <div class="form-group">
            <label for="max_rooms">Max Rooms</label>
            <input type="number" id="max_rooms" name="max_rooms" placeholder="10">
        </div>

        <div class="form-group">
            <label for="sort_by">Sort By</label>
            <select id="sort_by" name="sort_by">
                <option value="updated_at">Updated</option>
                <option value="price">Price</option>
                <option value="living_area">Area</option>
                <option value="city">City</option>
            </select>
        </div>

        <div class="form-group">
            <label for="sort_order">Order</label>
            <select id="sort_order" name="sort_order">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
            </select>
        </div>

        <div class="form-group" style="align-self: flex-end;">
            <button type="submit" class="btn">Search</button>
        </div>
    </form>
</div>

<div id="properties-list" hx-get="/api/properties" hx-trigger="load">
    <div class="card text-center">
        <p>Loading properties...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle htmx response to render properties
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'properties-list') {
        const data = JSON.parse(evt.detail.xhr.response);
        renderProperties(data);
    }
});

function renderProperties(data) {
    const container = document.getElementById('properties-list');

    if (!data.properties || data.properties.length === 0) {
        container.innerHTML = '<div class="card text-center"><p>No properties found. Try adjusting your filters.</p></div>';
        return;
    }

    let html = `<div class="card"><h3>Found ${data.total} properties (showing ${data.properties.length})</h3></div>`;

    data.properties.forEach(prop => {
        const price = prop.price ? `‚Ç¨${prop.price.toLocaleString()}` : 'Price N/A';
        const area = prop.living_area ? `${prop.living_area}m¬≤` : 'N/A';
        const rooms = prop.rooms || 'N/A';
        const city = prop.city || 'Unknown';

        html += `
        <div class="property-item">
            <div class="property-header">
                <div>
                    <h3>${prop.address || 'Address not available'}</h3>
                    <p>${city} ${prop.postal_code || ''}</p>
                </div>
                <div class="property-price">${price}</div>
            </div>
            <div class="property-details">
                <div class="property-detail">
                    <span class="detail-label">Living Area</span>
                    <span class="detail-value">${area}</span>
                </div>
                <div class="property-detail">
                    <span class="detail-label">Rooms</span>
                    <span class="detail-value">${rooms}</span>
                </div>
                <div class="property-detail">
                    <span class="detail-label">Bedrooms</span>
                    <span class="detail-value">${prop.bedrooms || 'N/A'}</span>
                </div>
                <div class="property-detail">
                    <span class="detail-label">Year Built</span>
                    <span class="detail-value">${prop.year_built || 'N/A'}</span>
                </div>
                <div class="property-detail">
                    <span class="detail-label">Energy Label</span>
                    <span class="detail-value">${prop.energy_label || 'N/A'}</span>
                </div>
                <div class="property-detail">
                    <span class="detail-label">Type</span>
                    <span class="detail-value"><span class="badge ${prop.listing_type === 'buy' ? 'badge-success' : 'badge-info'}">${prop.listing_type}</span></span>
                </div>
            </div>
            <div class="mt-2">
                <a href="${prop.url}" target="_blank" class="btn btn-secondary">View on Funda</a>
                <a href="/api/properties/${prop.id}" class="btn">Details & History</a>
            </div>
        </div>
        `;
    });

    container.innerHTML = html;
}

// Trigger scrape function
async function triggerScrape() {
    const city = document.getElementById('scrape-city').value;
    const propertyType = document.getElementById('scrape-type').value;
    const maxPages = parseInt(document.getElementById('scrape-pages').value);
    const statusDiv = document.getElementById('scrape-status');
    const btn = document.getElementById('scrape-btn');

    // Validate
    if (maxPages < 1 || maxPages > 100) {
        statusDiv.innerHTML = '<span style="color: red;">‚ùå Pages must be between 1 and 100</span>';
        return;
    }

    // Disable button
    btn.disabled = true;
    btn.textContent = '‚è≥ Starting scrape...';
    statusDiv.innerHTML = '<span style="color: blue;">‚è≥ Starting scrape...</span>';

    try {
        const response = await fetch('/api/scrape/trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                city: city,
                property_type: propertyType,
                max_pages: maxPages
            })
        });

        const data = await response.json();

        if (response.ok) {
            statusDiv.innerHTML = `
                <span style="color: green;">‚úÖ ${data.message}</span><br>
                <small>Estimated: ~${data.estimated_properties} properties in ~${data.estimated_minutes} minutes</small><br>
                <small>Check status at <a href="/scrapes">/scrapes</a> or refresh this page when complete</small>
            `;

            // Re-enable button after 10 seconds
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = 'üîÑ Scrape Properties';
            }, 10000);
        } else {
            statusDiv.innerHTML = `<span style="color: red;">‚ùå Error: ${data.detail}</span>`;
            btn.disabled = false;
            btn.textContent = 'üîÑ Scrape Properties';
        }
    } catch (error) {
        statusDiv.innerHTML = `<span style="color: red;">‚ùå Network error: ${error.message}</span>`;
        btn.disabled = false;
        btn.textContent = 'üîÑ Scrape Properties';
    }
}
</script>
{% endblock %}
